[platformio]
default_envs = esp32dev

[env]
platform = espressif32 @ ~6.9.0
framework = arduino
monitor_speed = 115200
board_build.flash_mode = dio
upload_speed = 921600

build_flags =
  -DCORE_DEBUG_LEVEL=3
  -DARDUINOJSON_USE_DOUBLE=1
  -DASYNC_TCP_SSL_ENABLED=0
  -DDEVICE_ID=\"vehiculo-01\"
  -DTOPIC_PREFIX=\"ks/prod/\"
  -DGPS_HZ=1
  -DWHEELS_HZ=10
  -DACTUATOR_HZ=2
  ; --- Serial speeds ---
  -DUSB_BAUD=115200
  -DGPS_BAUD=9600
  ; --- UART GPS (UART1) ---
  -DGPS_UART_NUM=1
  -DGPS_RX_PIN=16        ; RX1 (GPS->ESP32)
  -DGPS_TX_PIN=17        ; TX1 (ESP32->GPS)
  ; --- UART2 RasPi <-> ESP32 ---
  ; -DRPI_UART_NUM=2
  ; -DRPI_RX2_PIN=... 
  ; -DRPI_TX2_PIN=...
  ; --- DRV8833 #1 (Output) ---
  -DDRV1_AIN1=23         ; Motor1 PWM
  -DDRV1_AIN2=22         ; Motor1 DIR
  -DDRV1_BIN1=19         ; Motor2 PWM
  -DDRV1_BIN2=18         ; Motor2 DIR
  ; --- DRV8833 #2 (Output) ---
  -DDRV2_AIN1=13         ; Motor3 PWM
  -DDRV2_AIN2=21         ; Motor3 DIR
  -DDRV2_BIN1=32         ; Motor4 PWM 
  -DDRV2_BIN2=33         ; Motor4 DIR  
  ; --- STBY shared ---
  -DDRV_STBY=27
  ; --- Speed sensors---
  -DSPEED_S1_PIN=25      ; entrada (Pull-up)
  -DSPEED_S2_PIN=26      ; entrada (Pull-up)
  -DSPEED_S3_PIN=36      ; entrada (input-only)
  -DSPEED_S4_PIN=39      ; entrada (input-only)
  ; --- PWM global ---
  -DPWM_FREQ=20000
  -DPWM_RES_BITS=10

lib_deps =
  bblanchon/ArduinoJson @ ^7.2.0
  ottowinter/AsyncMqttClient-esphome @ ^0.8.6
  mikalhart/TinyGPSPlus @ ^1.1.0

; ---------- APP NORMAL ----------
[env:esp32dev]
board = esp32dev
build_flags = ${env.build_flags} -DENV_DEV=1
build_src_filter =
  +<*>
  -<../test/**>

[env:esp32-prod]
board = esp32dev
build_flags = ${env.build_flags} -DENV_PROD=1
build_src_filter =
  +<*>
  -<../test/**>

; ---------- TESTS (firmwares, sin ifdef) ----------
[env:esp32-test-unit]
board = esp32dev
build_flags = ${env.build_flags} -DTEST_UNIT=1
build_src_filter =
  +<*>
  -<main.cpp>
  +<../test/unit_test/**>
  -<../test/integration_test/**>

[env:esp32-test-integration]
board = esp32dev
build_flags = ${env.build_flags} -DTEST_INTEGRATION=1
build_src_filter =
  +<*>
  -<main.cpp>
  +<../test/integration_test/**>
  -<../test/unit_test/**>
